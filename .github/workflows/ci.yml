name: CI Pipeline - Exercice 2

on:
  push:
    branches: [ main, dev-quality-system ]
  pull_request:
    branches: [ main ]

jobs:
  run-all-tests:
    runs-on: ubuntu-latest
    name: ğŸ§ª ExÃ©cuter tous les tests
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install pipenv
        pipenv install --dev
    
    - name: ğŸ“ Run linter (flake8)
      run: |
        echo "=== LINTER ==="
        pipenv run flake8 . --count --max-complexity=15 --max-line-length=127 --exit-zero
        echo "âœ… Linter exÃ©cutÃ©"
    
    - name: ğŸ—„ï¸ Setup Django database (SQLite)
      run: |
        echo "=== CONFIGURATION BASE DE DONNÃ‰ES ==="
        pipenv run python manage.py migrate --noinput
        echo "âœ… Base de donnÃ©es SQLite configurÃ©e"
    
    - name: ğŸ§ª Run Django tests and generate JSON report
      id: django-tests
      run: |
        echo "=== TESTS DJANGO ==="
        pipenv run python manage.py test --noinput --verbosity=2 || echo "âš ï¸ Certains tests Django ont Ã©chouÃ©"
        
        echo "=== GÃ‰NÃ‰RATION RAPPORT TESTS DJANGO ==="
        pipenv run python generate_test_report.py || echo "âš ï¸ Impossible de gÃ©nÃ©rer le rapport"
        
        if [ -f "result_test_auto.json" ]; then
          echo "âœ… Rapport Django gÃ©nÃ©rÃ©: result_test_auto.json"
          
          # VÃ©rification simple du fichier - SYNTAXE CORRECTE
          echo "ğŸ“Š VÃ©rification du rapport Django..."
          python3 -c "import json
try:
    with open('result_test_auto.json') as f:
        data = json.load(f)
    print('Rapport Django valide')
except Exception as e:
    print(f'Erreur: {e}')"
        else
          echo "âŒ Rapport Django non gÃ©nÃ©rÃ©. Fin du pipeline."
          exit 1
        fi
    
    - name: ğŸŒ Start Django server for Selenium
      run: |
        echo "=== DÃ‰MARRAGE SERVEUR DJANGO ==="
        pipenv run python manage.py runserver 0.0.0.0:8000 &
        echo $! > django_server.pid
        sleep 5
        
        if curl -f http://localhost:8000/ > /dev/null 2>&1; then
          echo "âœ… Serveur Django dÃ©marrÃ©"
        else
          echo "âŒ Serveur Django non accessible"
          exit 1
        fi
    
    - name: ğŸŒ Run Selenium tests and generate JSON report
      id: selenium-tests
      run: |
        echo "=== TESTS SELENIUM ==="
        
        sudo apt-get update
        sudo apt-get install -y wget unzip
        
        wget -q -O chrome.deb "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
        sudo apt-get install -y ./chrome.deb || sudo apt-get install -f -y
        rm -f chrome.deb
        
        # Version simplifiÃ©e de ChromeDriver
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1)
        echo "Chrome version: $CHROME_VERSION"
        
        wget -q "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/120.0.6099.109/linux64/chromedriver-linux64.zip"
        unzip -o chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf chromedriver-linux64.zip chromedriver-linux64
        
        echo "ğŸ§ª ExÃ©cution des tests Selenium..."
        sleep 3
        
        pipenv run python selenium_test.py || echo "âš ï¸ Tests Selenium avec erreurs"
        
        if [ -f "result_test_selenium.json" ]; then
          echo "âœ… Rapport Selenium gÃ©nÃ©rÃ©"
        else
          echo "âš ï¸ Aucun rapport Selenium"
        fi
    
    - name: â™¿ Run accessibility tests
      id: accessibility-tests
      run: |
        echo "=== TESTS D'ACCESSIBILITÃ‰ ==="
        
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        
        sudo npm install -g pa11y-ci@5
        
        if ! curl -f http://localhost:8000/ > /dev/null 2>&1; then
          echo "âŒ Serveur non accessible"
          exit 1
        fi
        
        pa11y-ci --json http://localhost:8000/ > accessibility_report.json 2>/dev/null || true
        
        if [ -f "accessibility_report.json" ]; then
          echo "âœ… Rapport accessibilitÃ© gÃ©nÃ©rÃ©"
        else
          echo "âš ï¸ Aucun rapport accessibilitÃ©"
        fi
    
    - name: ğŸ›‘ Stop Django server
      if: always()
      run: |
        if [ -f "django_server.pid" ]; then
          kill $(cat django_server.pid) 2>/dev/null || true
          rm -f django_server.pid
          echo "âœ… Serveur arrÃªtÃ©"
        fi
    
    - name: ğŸ“Š Generate simple test summary
      run: |
        echo "=== ğŸ“Š RÃ‰SUMÃ‰ DES TESTS ==="
        echo ""
        
        # RÃ©sumÃ© Django - SYNTAXE CORRECTE
        if [ -f "result_test_auto.json" ]; then
          echo "ğŸ§ª TESTS DJANGO:"
          python3 -c "
import json
try:
    with open('result_test_auto.json') as f:
        data = json.load(f)
    stats = data.get('statistics', {})
    print(f'  PassÃ©s: {stats.get(\"passed\", 0)}')
    print(f'  Ã‰chouÃ©s: {stats.get(\"failed\", 0)}')
    print(f'  Manuels: {stats.get(\"manual\", 0)}')
    print(f'  Total: {stats.get(\"total\", 0)}')
except Exception as e:
    print(f'  Erreur: {e}')
"
        else
          echo "ğŸ§ª TESTS DJANGO: Non disponibles"
        fi
        
        echo ""
        
        # RÃ©sumÃ© Selenium - SYNTAXE CORRECTE
        if [ -f "result_test_selenium.json" ]; then
          echo "ğŸŒ TESTS SELENIUM:"
          python3 -c "
import json
try:
    with open('result_test_selenium.json') as f:
        data = json.load(f)
    stats = data.get('summary', {})
    print(f'  PassÃ©s: {stats.get(\"passed\", 0)}')
    print(f'  Ã‰chouÃ©s: {stats.get(\"failed\", 0)}')
    print(f'  Total: {stats.get(\"total\", 0)}')
except Exception as e:
    print(f'  Erreur: {e}')
"
        else
          echo "ğŸŒ TESTS SELENIUM: Non disponibles"
        fi
        
        echo ""
        
        # RÃ©sumÃ© AccessibilitÃ© - SYNTAXE CORRECTE
        if [ -f "accessibility_report.json" ]; then
          echo "â™¿ TESTS ACCESSIBILITÃ‰:"
          python3 -c "
import json
try:
    with open('accessibility_report.json') as f:
        data = json.load(f)
    
    if isinstance(data, list) and len(data) > 0:
        issues = data[0].get('issues', [])
        errors = len([i for i in issues if i.get('type') == 'error'])
        warnings = len([i for i in issues if i.get('type') == 'warning'])
        
        print(f'  Erreurs: {errors}')
        print(f'  Warnings: {warnings}')
        print(f'  Total problÃ¨mes: {len(issues)}')
    else:
        print('  Format de rapport invalide')
except Exception as e:
    print(f'  Erreur: {e}')
"
        else
          echo "â™¿ TESTS ACCESSIBILITÃ‰: Non disponibles"
        fi
    
    - name: ğŸ“ Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          result_test_auto.json
          result_test_selenium.json
          accessibility_report.json
        retention-days: 30
    
    - name: ğŸ’¬ Comment on Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          const fs = require('fs');
          
          try {
            let djangoData = { statistics: { passed: 0, failed: 0, manual: 0, total: 0 } };
            let seleniumData = { summary: { passed: 0, failed: 0, total: 0 } };
            let accessibilityData = { issues: [] };
            
            try { 
              djangoData = JSON.parse(fs.readFileSync('result_test_auto.json', 'utf8')); 
            } catch (e) { 
              console.log('Django report not found'); 
            }
            
            try { 
              seleniumData = JSON.parse(fs.readFileSync('result_test_selenium.json', 'utf8')); 
            } catch (e) { 
              console.log('Selenium report not found'); 
            }
            
            try {
              const acc = JSON.parse(fs.readFileSync('accessibility_report.json', 'utf8'));
              if (Array.isArray(acc) && acc.length > 0) {
                accessibilityData = acc[0];
              }
            } catch (e) { 
              console.log('Accessibility report not found'); 
            }
            
            const django = djangoData.statistics;
            const selenium = seleniumData.summary;
            const issues = accessibilityData.issues || [];
            
            const errors = issues.filter(i => i.type === 'error').length;
            const warnings = issues.filter(i => i.type === 'warning').length;
            
            const totalAuto = (django.total - django.manual) + selenium.total;
            const totalPassed = django.passed + selenium.passed;
            const successRate = totalAuto > 0 ? (totalPassed / totalAuto * 100).toFixed(1) : '0';
            
            const hasFailed = django.failed > 0 || selenium.failed > 0 || errors > 0;
            const status = hasFailed ? 'âŒ Ã‰CHEC' : 'âœ… SUCCÃˆS';
            
            let comment = `## ${status} - RÃ©sultats des Tests\n\n`;
            comment += `**Django:** âœ…${django.passed} âŒ${django.failed} ğŸ‘¤${django.manual} | **Selenium:** âœ…${selenium.passed} âŒ${selenium.failed}\n`;
            comment += `**AccessibilitÃ©:** âŒ${errors} âš ï¸${warnings}\n\n`;
            comment += `**Taux de rÃ©ussite:** ${successRate}%\n\n`;
            comment += `*Rapport gÃ©nÃ©rÃ© automatiquement*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            console.log('âœ… Commentaire ajoutÃ© Ã  la PR');
            
          } catch (error) {
            console.error('Erreur:', error);
          }
