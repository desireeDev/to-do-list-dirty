name: CI Pipeline - Exercice 2

on:
  push:
    branches: [ main, dev-quality-system ]
  pull_request:
    branches: [ main ]

jobs:
  setup-and-lint:
    runs-on: ubuntu-latest
    name: ‚öôÔ∏è Setup & Lint
    timeout-minutes: 5
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Setup Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        pip install pipenv
        pipenv install --dev
    
    - name: üìù Run linter (flake8)
      run: |
        echo "=== LINTER ==="
        pipenv run flake8 . --count --max-complexity=15 --max-line-length=127 || true
        echo "‚úÖ Linter ex√©cut√©"

  django-tests:
    runs-on: ubuntu-latest
    name: üß™ Tests Django
    needs: setup-and-lint
    timeout-minutes: 5
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        pip install pipenv
        pipenv install --dev
    
    - name: üóÑÔ∏è Setup Django database
      run: |
        echo "=== CONFIGURATION BASE DE DONN√âES ==="
        pipenv run python manage.py migrate --noinput
        echo "‚úÖ Base de donn√©es SQLite configur√©e"
    
    - name: üß™ Run Django tests
      id: run-django-tests
      run: |
        echo "=== TESTS DJANGO ==="
        # Utilise ton fichier test.py existant
        pipenv run python manage.py test tasks.tests --noinput --verbosity=2
        
    - name: üìä Generate Django report
      if: always()
      run: |
        echo "=== G√âN√âRATION RAPPORT TESTS DJANGO ==="
        # Utilise ton script existant
        pipenv run python generate_test_report.py
        echo "‚úÖ Rapport Django g√©n√©r√©"

  selenium-tests:
    runs-on: ubuntu-latest
    name: üåê Tests Selenium
    needs: django-tests
    timeout-minutes: 10
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        pip install pipenv
        pipenv install --dev
        pipenv run pip install selenium webdriver-manager
    
    - name: üèóÔ∏è Setup Chrome & ChromeDriver
      uses: nanasess/setup-chromedriver@v2  # ‚Üê SOLUTION CORRECTE
    
    - name: üóÑÔ∏è Setup Django database
      run: |
        pipenv run python manage.py migrate --noinput
    
    - name: üåê Start Django server
      run: |
        echo "=== D√âMARRAGE SERVEUR DJANGO ==="
        pipenv run python manage.py runserver 0.0.0.0:8000 &
        echo $! > django_server.pid
        sleep 5
        curl -f http://localhost:8000/ && echo "‚úÖ Serveur Django d√©marr√©"
    
    - name: üß™ Run Selenium tests
      run: |
        echo "=== TESTS SELENIUM ==="
        # Utilise ton fichier selenium_test.py existant
        pipenv run python selenium_test.py
        echo "‚úÖ Tests Selenium ex√©cut√©s"
    
    - name: üõë Stop Django server
      if: always()
      run: |
        if [ -f "django_server.pid" ]; then
          kill $(cat django_server.pid) 2>/dev/null || true
          rm -f django_server.pid
          echo "‚úÖ Serveur arr√™t√©"
        fi

  accessibility-tests:
    runs-on: ubuntu-latest
    name: ‚ôø Tests Accessibilit√©
    needs: selenium-tests  # Attends que Selenium finisse
    timeout-minutes: 5
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        pip install pipenv
        pipenv install --dev
    
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4  # ‚Üê SOLUTION S√âCURIS√âE
      with:
        node-version: '18'
    
    - name: üì¶ Install pa11y-ci
      run: npm install -g pa11y-ci@5
    
    - name: üóÑÔ∏è Setup Django database
      run: |
        pipenv run python manage.py migrate --noinput
    
    - name: üåê Start Django server
      run: |
        echo "=== D√âMARRAGE SERVEUR DJANGO ==="
        pipenv run python manage.py runserver 0.0.0.0:8000 &
        echo $! > django_server.pid
        sleep 5
        curl -f http://localhost:8000/ && echo "‚úÖ Serveur Django d√©marr√©"
    
    - name: ‚ôø Run accessibility tests
      run: |
        echo "=== TESTS D'ACCESSIBILIT√â ==="
        pa11y-ci --json http://localhost:8000/ > accessibility_report.json 2>/dev/null || true
        echo "‚úÖ Tests accessibilit√© ex√©cut√©s"
    
    - name: üõë Stop Django server
      if: always()
      run: |
        if [ -f "django_server.pid" ]; then
          kill $(cat django_server.pid) 2>/dev/null || true
          rm -f django_server.pid
          echo "‚úÖ Serveur arr√™t√©"
        fi

  generate-reports:
    runs-on: ubuntu-latest
    name: üìä G√©n√©rer Rapports
    needs: [django-tests, selenium-tests, accessibility-tests]
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üìà Generate summary
      run: |
        echo "=== üìä R√âSUM√â DES TESTS ==="
        echo ""
        
        # R√©sum√© Django
        if [ -f "result_test_auto.json" ]; then
          echo "üß™ TESTS DJANGO:"
          pipenv run python -c "
import json
try:
    with open('result_test_auto.json') as f:
        data = json.load(f)
    stats = data.get('statistics', {})
    print(f'  Pass√©s: {stats.get(\"passed\", 0)}')
    print(f'  √âchou√©s: {stats.get(\"failed\", 0)}')
    print(f'  Manuels: {stats.get(\"manual\", 0)}')
    print(f'  Total: {stats.get(\"total\", 0)}')
except Exception as e:
    print(f'  Erreur: {e}')
"
        else
          echo "üß™ TESTS DJANGO: Non disponibles"
        fi
        
        echo ""
        
        # R√©sum√© Selenium
        if [ -f "result_test_selenium.json" ]; then
          echo "üåê TESTS SELENIUM:"
          pipenv run python -c "
import json
try:
    with open('result_test_selenium.json') as f:
        data = json.load(f)
    stats = data.get('summary', {})
    print(f'  Pass√©s: {stats.get(\"passed\", 0)}')
    print(f'  √âchou√©s: {stats.get(\"failed\", 0)}')
    print(f'  Total: {stats.get(\"total\", 0)}')
except Exception as e:
    print(f'  Erreur: {e}')
"
        else
          echo "üåê TESTS SELENIUM: Non disponibles"
        fi
        
        echo ""
        
        # R√©sum√© Accessibilit√©
        if [ -f "accessibility_report.json" ]; then
          echo "‚ôø TESTS ACCESSIBILIT√â:"
          pipenv run python -c "
import json
try:
    with open('accessibility_report.json') as f:
        data = json.load(f)
    if isinstance(data, list) and len(data) > 0:
        issues = data[0].get('issues', [])
        errors = len([i for i in issues if i.get('type') == 'error'])
        warnings = len([i for i in issues if i.get('type') == 'warning'])
        print(f'  Erreurs: {errors}')
        print(f'  Warnings: {warnings}')
        print(f'  Total probl√®mes: {len(issues)}')
    else:
        print('  Format de rapport invalide')
except Exception as e:
    print(f'  Erreur: {e}')
"
        else
          echo "‚ôø TESTS ACCESSIBILIT√â: Non disponibles"
        fi
    
    - name: üìÅ Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          result_test_auto.json
          result_test_selenium.json
          accessibility_report.json
        retention-days: 30

  comment-on-pr:
    runs-on: ubuntu-latest
    name: üí¨ Commenter sur PR
    needs: generate-reports
    if: github.event_name == 'pull_request'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üì• Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: test-reports
        path: ./
    
    - name: üí¨ Comment on Pull Request
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          const fs = require('fs');
          
          try {
            // Lire les rapports
            let djangoData = { statistics: { passed: 0, failed: 0, manual: 0, total: 0 } };
            let seleniumData = { summary: { passed: 0, failed: 0, total: 0 } };
            let accessibilityData = { issues: [] };
            
            try { 
              djangoData = JSON.parse(fs.readFileSync('result_test_auto.json', 'utf8')); 
            } catch (e) { 
              console.log('‚ö†Ô∏è Rapport Django non trouv√©'); 
            }
            
            try { 
              seleniumData = JSON.parse(fs.readFileSync('result_test_selenium.json', 'utf8')); 
            } catch (e) { 
              console.log('‚ö†Ô∏è Rapport Selenium non trouv√©'); 
            }
            
            try {
              const acc = JSON.parse(fs.readFileSync('accessibility_report.json', 'utf8'));
              if (Array.isArray(acc) && acc.length > 0) {
                accessibilityData = acc[0];
              }
            } catch (e) { 
              console.log('‚ö†Ô∏è Rapport accessibilit√© non trouv√©'); 
            }
            
            const django = djangoData.statistics;
            const selenium = seleniumData.summary;
            const issues = accessibilityData.issues || [];
            
            const errors = issues.filter(i => i.type === 'error').length;
            const warnings = issues.filter(i => i.type === 'warning').length;
            
            const totalAuto = (django.total - django.manual) + selenium.total;
            const totalPassed = django.passed + selenium.passed;
            const successRate = totalAuto > 0 ? (totalPassed / totalAuto * 100).toFixed(1) : '0';
            
            const hasFailed = django.failed > 0 || selenium.failed > 0 || errors > 0;
            const status = hasFailed ? '‚ùå √âCHEC' : '‚úÖ SUCC√àS';
            
            let comment = `## ${status} - R√©sultats des Tests (PR #${context.issue.number})\n\n`;
            comment += `**Ex√©cut√© le:** ${new Date().toLocaleString('fr-FR')}\n`;
            comment += `**Branche:** ${context.payload.pull_request.head.ref} ‚Üí ${context.payload.pull_request.base.ref}\n\n`;
            
            comment += `### üß™ Tests Django\n`;
            comment += `‚úÖ **Pass√©s:** ${django.passed} | ‚ùå **√âchou√©s:** ${django.failed} | üë§ **Manuels:** ${django.manual}\n\n`;
            
            comment += `### üåê Tests Selenium\n`;
            comment += `‚úÖ **Pass√©s:** ${selenium.passed} | ‚ùå **√âchou√©s:** ${selenium.failed}\n\n`;
            
            comment += `### ‚ôø Tests Accessibilit√©\n`;
            comment += `‚ùå **Erreurs:** ${errors} | ‚ö†Ô∏è **Warnings:** ${warnings}\n\n`;
            
            comment += `### üìà R√©sum√© Global\n`;
            comment += `${status} **Taux de r√©ussite:** ${successRate}%\n`;
            
            // Tests manuels restants
            if (django.manual > 0) {
              comment += `\n### ‚ö†Ô∏è Tests Manuels Restants\n`;
              comment += `**${django.manual}** test(s) manuel(s) √† r√©aliser:\n`;
              comment += `- TC022: Navigation compl√®te utilisateur\n`;
              comment += `- TC023: Interface responsive\n`;
              comment += `- TO01: Test E2E manuel\n`;
            }
            
            comment += `\n---\n`;
            comment += `üìÅ **Rapports disponibles dans les artefacts**\n`;
            comment += `*G√©n√©r√© automatiquement par GitHub Actions*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            console.log('‚úÖ Commentaire ajout√© √† la PR');
            
          } catch (error) {
            console.error('‚ùå Erreur:', error);
          }
